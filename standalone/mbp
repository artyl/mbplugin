#!/bin/bash
#ls env/bin/activate

util_path=$(dirname $0)/../plugin/util.py
root_path=$(realpath $(dirname $0))
[ -f $util_path ] && root_path=$(realpath $(dirname $0)/../..)
echo "root_path is $root_path"

# if not use docker - remove dockervar
if [ -f $util_path ] && [ "$1" = "" ]; then
    [ -f dockervar ] && rm dockervar
fi

if [ -f $util_path ] && [ "$1" = "docker" ]; then 
    if [ ! -x "$(command -v docker)" ]; then
        echo "Install docker. See https://docs.docker.com/engine/install"
        exit 1
    fi
    echo 'DOCKER="docker run --rm -it -v $PWD:/mbstandalone mbplugin "' > dockervar
    # Build image for playwright
    docker build --tag mbplugin mbplugin/docker
    # -p 127.0.0.1:19777:19777
fi

[ -f dockervar ] && . ./dockervar 

# port mapping for docker only for run-web-server
if [ "$DOCKER" != "" ] && [ "$1" = "run-web-server" ]; then
    DOCKER=${DOCKER/ mbplugin/ -p 127.0.0.1:19777:19777 mbplugin}
    echo $DOCKER
fi

pythonver=$(python -V 2>&1 | sed 's/.* \([0-9]\).\([0-9]\).*/\1\2/')
if [ ! -f dockervar ] && [ "$pythonver" -lt "38" ] && [ -f env/bin/activate ] ; then 
    . env/bin/activate
fi

pythonver=$(python -V 2>&1 | sed 's/.* \([0-9]\).\([0-9]\).*/\1\2/')
if [ ! -f dockervar ] && [ "$pythonver" -lt "38" ] ; then
    echo "This script requires python 3.8 or greater, you have $pythonver"
    exit 1
fi

# ../plugin/util.py exists go into installation mode
if [ -f $util_path ]; then 
    echo "The file $(realpath $util_path) exist";
    cd $root_path
    cp mbplugin/standalone/mbp .
    chmod +x mbp
    [ ! -f phones.ini ] && cp mbplugin/standalone/phones.ini . 
    $DOCKER python mbplugin/plugin/util.py standalone-init
    $DOCKER python mbplugin/plugin/util.py pip-update
    $DOCKER python mbplugin/plugin/util.py install-chromium
    $DOCKER python mbplugin/plugin/util.py check-import
    $DOCKER python mbplugin/plugin/util.py check-ini
    $DOCKER python mbplugin/plugin/util.py clear-browser-cache
    $DOCKER python mbplugin/plugin/util.py check-playwright
    exit 0
fi

cd $root_path
$DOCKER python mbplugin/plugin/util.py $*
