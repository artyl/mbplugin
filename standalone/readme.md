# Самостоятельно работающая версия
Главное преимущество - это полное остутствие ограничений, накладываемых лицензией mobilebalance, можно проверять любое количество телефонов.

## Вариант работающий на текущем коде

Если Ваша цель только получить баланс телефонов в виде web странички - то mbplugin может запускаться как скрипт по расписанию и не иметь постоянно запущенной части по завершении проверки будет генерироваться файл страничка `balance.html` которую можно просто открыть в браузере.
Если Вы хотите иметь доступ ко всем возможностям (Telegram bot, просмотрт логов, расписание проверок и т.п.), то необходимо запускать web сервер, он легковесный, и ресурсов в состоянии покоя много потреблять не должен. 

## Итак инструкция по установке

1. Создаем в удобном месте папку mbstandalone (название можете выбрать какое нравиться, это не принципиально)
2. Помещаем, если есть, в эту папку phones.ini от MobileBalance. Если его нет, то на этапе инициализации будет создан демо файл с примерами
3. Распаковываем в эту папку содержимое архива (папка mbplugin) либо установить через git 
4. Из папки `mbplugin\standalone` запускаем `mbp.bat`, По Linux и Mac смотри ниже в разделе установка окружения на Linux и Mac
при запуске из этой папки он запускается в режиме установки (создаст ini если его еще не, и скопирует себя в папку mbstandalone, загрузит chromium, проведет проверки). 
5. Настраиваем телефоны в `phones.ini`, при установке будет скопирован файл примера из mbplugin\standalone с двумя телефонами. Если у вас уже есть `phones.ini` положите его в папку вместо `phones.ini` с примером и настройте пароли Password2  
ВАЖНО Когда вы будете добавлять новые номера, то номера секций (`[Phone] #номер`) не должны повторяться  
Запрос баланса будет работать только для телефонов, у которых в поле password2 прописан пароль (см пример phones.ini в папке mbplugin\standalone).  

***!!! Все команды после установки мы запускаем из корневой папки mbstandalone***  
Для варианта работы через Docker команды будут отличаться (см раздел про Docker)

7. Для получения балансов ```mbp get-balance```
8. Если нужно запросить только балансы, по которым были ошибки запустите ```mbp get-balance --only_failed```
9. Чтобы только обновить balance.html без получения балансов ```mbp refresh-balance-html```
10. Если нужно получить по части балансов запустите ```mbp get-balance filter1 filter2 ...``` будут получены только балансы у которых один из фильтров совпадет с плагином или логином
11. Для настройки автоматической проверки баланса необходимо воспользоваться встроенным в web сервер планировщиком (см Расписание проверок) либо по какому-то расписанию запускать ```mbp get-balance``` например через системный планировщик ```taskschd.msc```либо как-то еще

## Установка окружения на Linux и Mac
Инструкция по установке на Linux и Mac
Как оказалось иконка в трее нормально работает только в винде, не смотря на декларируемую кроссплатформенность библиотеки pystray, хотя может это я просто до конца не разобрался, так что управлять запущенным веб сервером можно по url (http://localhost:19777/main)[http://localhost:19777/main] или командами из mbp
Далее в зависимости от варианта 
### Вариант работы через Docker
[Устанавливаем докер](https://docs.docker.com/engine/install) - выберете инструкцию под свою систему  
Данный вариант прост и хорошо управляем, повторяем, независим от версий приложений установленных в системе, работает в серверном варианте без установленного GUI и является рекомендуемым мной, но требует установки Docker (там в принципе ничего сложного) и сам контейнер с Playwright занимает порядка 2 GB на диске (для современных дисков по моему тоже не сильно критично). Если с местом проблемы, или не хотите устанавливать докер то попробуйте вариант без докера с установкой всего в систему (В целом тоже рабочее решение, но вероятность проблем по ходу, если Вы с ситемой не на ты - выше).  
Cпецифический момент при работе через докер.
Т.к. запуск в докере - это запуск по сути на отдельной машине для доступа к web серверу нам необходимо разрешить доступ на web сервер извне, не с localhost - поэтому `host=0.0.0.0`, доступ к web серверу извне будет ограничен параметром при запуске докера `-p 127.0.0.1:19777:19777`.  
Управлять сервером можно также командами TG бота или командами через mbp, а баланс смотреть в TG либо в файле `balance.html` так что доступ извне к web можно и не включать  
***Важно*** если вы будете запускать веб сервер без докера, то обязательно выключите доступ к веб серверу снаружи `host=127.0.0.1` иначе web сервер будет доступен с других компьютеров сети  
Обратите внимание что для настройки работы через докер мы запускаем инициализацию с параметром docker -  `mbplugin/standalone/mbp docker`
Итак:  
```
# build docker image
docker build --tag mbplugin mbplugin/docker
# init
bash mbplugin/standalone/mbp docker
# Если хотим управлять web сервером и открывать страницу баланса с него то разрешаем доступ к серверу извне (см коментарий выше)
mbp set ini/HttpServer/host=0.0.0.0
# Запуск web сервера
mbp run-web-server  
# Запрос баланса с генерацией balance.html (можно запускать без web сервера)
mbp get-balance 

```
### Установка без контейнеров
Т.к. я пока до конца не разобрался как правильно устанавливать python >=3.8 то возможно предлагаемый мной вариант не самый правильный
1. устанавливаем 
```
# устанавливаем python 3.8 в ubuntu так, в других системах по другому (смотрите инструкцию под свою систему)
sudo apt-get install python3.8 python3.8-dev python3.8-venv
python3.8 -m venv env
source env/bin/activate
python -m pip install -r mbplugin/docker/requirements.txt
sh mbplugin/standalone/mbp
```
2. Получаем баланс 
```
# Можно запустить веб сервер (удобный просмотр лога и прочее)
mbp run-web-server
# Для запроса баланса дать команду (это работает как с веб севером так и без)  
mbp get-balance
```

## Расписание проверок
В веб сервер встроен планировщик заданий проверки. Естественно чтобы он работал должен быть запущен веб сервер.  
Для добавления заданий добавьте в секцию `[HttpServer]` одну или несколько строк, **Важно** - у всех строк номера должны отличаться, один может быть без номера  
Если хотите проверять не все телефоны а только часть то после расписания через запятую перечислите фильтры для отбора номеров которые хотите проверить
Формат расписания повторяет формат в библиотеке [schedule](https://schedule.readthedocs.io/en/stable)  
Примеры:
```
;Проверять раз в 4 часа mts и beeline
schedule = every(4).hours,mts,beeline
;Проверять все номера один раз в день
schedule1 = every().day
;Проверять один раз в день в 10:30 номер 123456
schedule2 = every().day.at("10:30"),123456
```
После изменения расписания чтобы изменения применились запустите `mbp reload-schedule`

## Совместное использование standalone версии и MobileBalance, хранение паролей
Если планируется совместное использование standalone версии и MobileBalance, то при запуске Mobilebalance все чужеродные поля будут стерты из Phones.ini.  
Для этого был сделан механизм с файлом phones_add.ini.  
Вот как выглядит секция для телефона в phones.ini
```
[Phone] #1
Region               = p_test1
Monitor              = TRUE
Alias                = Ivanych
Number               = 9161112233
Password2 = 123password
```
Создаем phones_add.ini и переносим поле Password2 в него. Phones_add.ini
```
[Phone] #1
Password2 = 123password
```
Все параметры прописанные в phones_add.ini будут при подгрузке перекрывать параметры в phones.ini

## Установка и обновление через git
Установите систему контроля версий [git](https://git-scm.com/)  
Вариант устанавливать через git хорош тем что можно легко обновлять версию (через `git pull`).
Установка из git
```
git clone https://github.com/artyl/mbplugin  
# пока у нас ветка так что переключаемся в нее
git -C mbplugin checkout -t remotes/origin/dev_playwright
```
На windows необходимо также либо выполнить установку python `mbplugin\python\get_python.bat` либо распаковать из архива папку mbplugin\python поверх существующей

Если вы устанавливали из архива, то необходимо добавить репозиторий к папке mbplugin:
```
git clone --bare https://github.com/artyl/mbplugin.git mbplugin/.git
git -C mbplugin config --local --bool core.bare false 
git -C mbplugin add .
git -C mbplugin reset
```
Для обновления версии до текущего master выполните команды (если вы производили какие-то изменения, в скриптах в папке mbplugin то они могут быть потеряны)
```
git -C mbplugin pull
git -C mbplugin checkout -f
```

## Для инфо

* __В Standalone версии для получения баланса не требуется веб сервер__, веб сервер нужен только для показа информации и обработки команд телеграм ботом. Так что если вы не собираетесть пользоваться телеграм ботом, а балансы смотреть через сгенеренную страничку balance.html с диска то web сервер можно не запускать. Отправка балансов в телеграм через send_tgbalance_onlysend.bat, также работает без вебсервера.
* Какой оператор указывается в phones.ini (пример файла phones.ini смотрите в папке standalone) в поле Region плагины это файлы в папке mbplugin\plugin т.е. например для плагина mts файл mts2.py а в поле нужно будет указать ```Region=p_mts2``` т.е. с префиксом p_ и без расширения
* На текущий момент доступен только просмотр веб страницы с балансом [http://localhost:19777/report](http://localhost:19777/report), открыть его можно выбрав Open report через иконку вебсервера в системном трее либо без вебсервера можер открыть balance.html в корневой папке standalone версии
* Для просмотра истории по балансу установите параметр RealAverageDays=число дней просмотра истории. Помните, что чем больше дней, тем дольше строится страница с балансом.
* Все данные по балансам хранятся в файле BalanceHistory.sqlite в корне проекта, это база данных sqllite при желании можно поработать с ней из других програм для построения какой-то аналитики.
* При желании можно настроить телеграм бота так же как для обычной версии, но только по варианту 2 (tg_from = sqlite, см общий readme раздел Телеграм бот вариант 2 (получаем балансы из sqlite))
* При желании можно запустить несколько mbplugin одновременно из разных папок на разных портах, но возможны коллизии при управлении хромом, когда несколько разных плагинов попытаются запускать их одновременно

## Текущие проблемы

Слабая диагностика ошибок в phones.ini который пока правится руками.

## Дальнейшее развитие

* Запросить неудачные попытки
* В дальнейшем это частично переедет в вебсервер, где будет шедулер и подобный функционал.
