# Самостоятельно работающая версия
Главное преимущество - это полное остутствие ограницений, накладываемых лицензией mobilebalance.

## Вариант работающий на текущем коде

Все это пока бэта для желающих поиграться, но в целом ей уже некоторые вполне пользуются. Возможно в процессе становления будут какие-то изменения с хранением настроек, но сама база вряд ли поменяется.
Если Ваша цель только получить баланс телефонов в виде web странички - то mbplugin может запускаться как скрипт по расписанию и не иметь постоянно запущенной части по завершении проверки будет генерироваться файл страничка balance.html
которую можно просто открыть в браузере.
Если Вы хотите иметь доступ ко всем возможностям (Telegram bot, просмотрт логов и т.п.), то необходимо запускать web сервер, он легковестный, и ресурсов в состоянии покой много потреблять не должен. 

## Итак инструкция по установке на Windows

1. Создаем в удобном месте папку mbstandalone (название можете выбрать какое нравиться, это не принципиально)
2. Распаковываем в эту папку содержимое архива (папка mbplugin)
3. Из папки mbplugin\standalone перекладываем файлы в корень папки mbstandalone
4. Запустить ```mbstandalone.bat``` без параметров или с параметром init (при первом запуске он настроит параметры по умолчанию и создаст базу BalanceHistory.sqlite для хранения результатов)
5. Настроить телефоны в phones.ini, в папке mbplugin\standalone уже находится настроенный пример с двумя телефонами
ВАЖНО номера секций ([Phone] #2) не должны повторяться
6. Для проверки корректности ini файлов запустить ```mbstandalone.bat check``` диагностика пока так себе, со временем будем в эту сторону копать
7. Для получения балансов ```mbstandalone.bat getbalance```
8. Если нужно запросить только балансы, по которым были ошибки запустите ```mbstandalone.bat getbalancefailed```
9. Чтобы только обновить balance.html без получения балансов ```mbstandalone.bat updatehtml```
10. Если нужно получить по части балансов запустите ```mbstandalone.bat getbalance filter1 filter2 ...``` будут получены только балансы у которых один из фильтров совпадет с плагином или логином
11. Для настройки автоматической проверки баланса необходимо по какому-то расписанию запускать ```mbstandalone.bat getbalance``` например через системный планировщик ```taskschd.msc```либо как-то еще

## Инструкция по установке на Linux и Mac (пока в стадии написания и осмысления)
Инструкцию даю из расчета что мы все размещаем в домашней папке, если хотите разместить в другом месте то скорректируйте пути  
Как оказалось иконка в трее нормально работает только в винде, не смотря на декларируемую кроссплатформенность, хотя может это я просто до конца не разобрался, так что управлять запущенным веб сервером можно по url (http://localhost:19777/main)[http://localhost:19777/main]
1. создаем в home папку mbstandalone и переходим в нее
```
mkdir mbstandalone  
cd mbstandalone  
```
2. Качаем репозиторий (здесь потом будет ссылка) или делаем (ветка dev потом тоже поменяется)
```
git clone https://github.com/artyl/mbplugin  
git -C mbplugin checkout -t remotes/origin/dev_playwright
```
3. копируем содержимое mbplugin/standalone в корень 
```
cp mbplugin/standalone/* .
```
Далее в зависимости от варианта 
### Вариант через Docker
Данный вариант прост и хорошо управляем, хорошо повторяем, независим от версий приложений установленных в системе, работает в серверном варианте без установленного GUI и является рекомендуемым мной, но требует установки Docker и сам контейнер с Playwright занимает порядка 2 GB на диске. Если с местом проблемы, или не хотите устанавливать докер то используйте вариант без докера.
Итак:  
[Устанавливаем докер](https://docs.docker.com/engine/install)  
Все дальнейшие действия выполняются из папки mbstandalone
```
# build docker image
docker build --tag mbplugin mbplugin/docker
# init
docker run --rm -it --name mbplugin1 -v $PWD:/mbstandalone mbplugin python mbplugin/plugin/util.py standalone-init 
docker run --rm -it --name mbplugin1 -v $PWD:/mbstandalone mbplugin python mbplugin/plugin/util.py set ini/HttpServer/host=0.0.0.0
### Вариант с web сервером
docker run --rm -d --name mbplugin1 -v $PWD:/mbstandalone -p 127.0.0.1:19777:19777 mbplugin python mbplugin/plugin/util.py run-web-server  
docker exec -it mbplugin1 python mbplugin/plugin/util.py standalone-get-balance 
### Вариант без web сервера (проста запрос баланса с генерацией balance.html)
docker run --rm -it --name mbplugin1 -v $PWD:/mbstandalone mbplugin python mbplugin/plugin/util.py standalone-get-balance 

```
### Установка без контейнеров
Т.к. я до конца не разобрался как правильно устанавливать python >=3.8 то возможно предлагаемый мной вариант не самый правильный
1. устанавливаем 
```
# устанавливаем python 3.8 в ubuntu так, в других системах по другому
sudo apt-get install python3.8 python3.8-venv
python3.8 -m venv env
source env/bin/activate
python -m pip install -r mbplugin/docker/requirements.txt
python mbplugin/plugin/util.py standalone-init
python mbplugin/plugin/util.py install-chromium
```
2. Получаем баланс 
```
source env/bin/activate
python mbplugin/plugin/util.py run-web-server
python mbplugin/plugin/util.py standalone-get-balance
```
## Для инфо

* __В Standalone версии для получения баланса не требуется веб сервер__, веб сервер нужен только для показа информации и обработки команд телеграм ботом. Так что если вы не собираетесть пользоваться телеграм ботом, а балансы смотреть через сгенеренную страничку balance.html с диска то web сервер можно не запускать. Отправка балансов в телеграм через send_tgbalance_onlysend.bat, также работает без вебсервера.
* Какой оператор указывается в phones.ini (пример файла phones.ini смотрите в папке standalone) в поле Region плагины это файлы в папке mbplugin\plugin т.е. например для плагина mts файл mts2.py а в поле нужно будет указать ```Region=p_mts2``` т.е. с префиксом p_ и без расширения
* На текущий момент доступен только просмотр веб страницы с балансом [http://localhost:19777/report](http://localhost:19777/report), открыть его можно выбрав Open report через иконку вебсервера в системном трее либо без вебсервера можер открыть balance.html в корневой папке standalone версии
* Для просмотра истории по балансу установите параметр RealAverageDays=число дней просмотра истории. Помните, что чем больше дней, тем дольше строится страница с балансом.
* Все данные по балансам хранятся в файле BalanceHistory.sqlite в корне проекта, это база данных sqllite при желании можно поработать с ней из других програм для построения какой-то аналитики.
* При желании можно настроить телеграм бота так же как для обычной версии, но только по варианту 2 (tg_from = sqlite, см общий readme раздел Телеграм бот вариант 2 (получаем балансы из sqlite))
* При желании можно запустить несколько mbplugin одновременно из разных папок на разных портах, но возможны коллизии при управлении хромом, когда несколько разных плагинов попытаются запускать их одновременно

## Текущие проблемы

Слабая диагностика ошибок в phones.ini который пока правится руками.

## Дальнейшее развитие

* Запросить неудачные попытки
* В дальнейшем это частично переедет в вебсервер, где будет шедулер и подобный функционал.
